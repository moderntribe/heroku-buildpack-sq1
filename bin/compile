#!/usr/bin/env bash

set -eu           # fail fast
set -o pipefail   # don't ignore exit codes when piping output
# set -x          # enable debugging

echo "-----> Buildpack Squareone"

# Configure directories
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

function install_wp_cli() {
    cd "${BUILD_DIR}"
    echo "Build Directory: ${BUILD_DIR}"

    echo "-----> Install WP-CLI"
    mkdir -p "${BUILD_DIR}/.heroku/wp/bin/"
    curl https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar -o "${BUILD_DIR}/.heroku/wp/bin/wp"
    chmod +x "$BUILD_DIR/.heroku/wp/bin/wp"
    "$BUILD_DIR/.heroku/wp/bin/wp" --info

    # linking to old path for backward compatibility
    mkdir -p "${BUILD_DIR}/.wpcli"
    ln -sf "$BUILD_DIR/.heroku/wp/bin/wp" "${BUILD_DIR}/.wpcli/wp"

    echo "-----> Setup Binary path"
    mkdir -p "${BUILD_DIR}/.profile.d"

cat <<EOF > "${BUILD_DIR}/.profile.d/200-wpcli.sh"
export PATH="$HOME/.heroku/wp/bin:$PATH"
EOF

}

install_wp_cli